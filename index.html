<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>وكيل EhabGM للتسويق الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure body takes full viewport height */
        }
        header {
            background-color: #1a202c; /* Darker header */
            color: #ffffff;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0;
        }
        main {
            flex-grow: 1; /* Allow main content to grow */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 90%;
            width: 100%; /* Ensure it takes full width on small screens */
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input[type="text"], textarea, select {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        button:hover {
            transform: translateY(-1px);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .report-section {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .report-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.5rem;
        }
        .report-section ul {
            list-style-type: disc;
            margin-right: 1.25rem;
            padding-right: 0;
        }
        .report-section ol {
            list-style-type: decimal;
            margin-right: 1.25rem;
            padding-right: 0;
        }
        .report-section li {
            margin-bottom: 0.5rem;
        }
        .report-section p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .report-section strong {
            color: #1f2937;
        }
        .logo-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem; /* Adjusted for consistency */
            padding: 1.5rem; /* Adjusted padding */
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out;
        }
        .logo-upload-section:hover {
            border-color: #3b82f6;
        }
        .logo-preview {
            max-width: 120px; /* Slightly smaller for better fit */
            max-height: 120px;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            width: 100%;
            margin-bottom: 1.5rem;
        }
        /* Enhanced loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            padding: 1rem;
            box-sizing: border-box;
        }
        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-animation {
            width: 120px;
            height: 120px;
            margin-bottom: 2rem;
            background: radial-gradient(circle, #3b82f6 10%, transparent 10%),
                        radial-gradient(circle, #2563eb 10%, transparent 10%),
                        radial-gradient(circle, #1d4ed8 10%, transparent 10%);
            background-size: 30% 30%;
            background-position: 0 50%, 50% 50%, 100% 50%;
            background-repeat: no-repeat;
            animation: pulse-dots 1.5s infinite alternate;
        }
        @keyframes pulse-dots {
            0% {
                background-position: 0 50%, 50% 50%, 100% 50%;
                opacity: 0.8;
            }
            33% {
                background-position: 0 30%, 50% 50%, 100% 70%;
                opacity: 1;
            }
            66% {
                background-position: 0 70%, 50% 50%, 100% 30%;
                opacity: 0.8;
            }
            100% {
                background-position: 0 50%, 50% 50%, 100% 50%;
                opacity: 0.8;
            }
        }
        .loading-message-container {
            height: 3rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .loading-message {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
            text-align: center;
            animation: fadeInOut 4s infinite;
            padding: 0 1rem;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Loading Tasks List */
        #loadingTasks {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
            width: 90%;
            max-width: 500px;
        }
        #loadingTasks li {
            background-color: #e0f2fe;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            color: #1e40af;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        #loadingTasks li.active {
            background-color: #bfdbfe;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
            transform: scale(1.02);
        }
        #loadingTasks li.completed {
            background-color: #d1fae5;
            color: #065f46;
            box-shadow: none;
            transform: none;
        }
        #loadingTasks li .task-icon {
            width: 24px;
            text-align: center;
            margin-left: 0.75rem;
        }
        #loadingTasks li .task-icon i {
            color: #3b82f6;
        }
        #loadingTasks li.active .task-icon i {
            color: #1e40af;
        }
        #loadingTasks li.completed .task-icon i {
            color: #10b981;
        }

        /* Social Share Buttons */
        .social-share-buttons button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            margin: 0.5rem;
        }
        .social-share-buttons button i {
            margin-left: 0.5rem;
        }
        .btn-whatsapp { background-color: #25D366; }
        .btn-whatsapp:hover { background-color: #1DA851; }
        .btn-facebook { background-color: #1877F2; }
        .btn-facebook:hover { background-color: #145CB3; }
        .btn-twitter { background-color: #1DA1F2; }
        .btn-twitter:hover { background-color: #168CC9; }
        .btn-linkedin { background-color: #0A66C2; }
        .btn-linkedin:hover { background-color: #074B92; }

        /* Print to PDF button style */
        .btn-pdf {
            background-color: #dc2626;
            color: #ffffff;
            margin-right: 1rem;
        }
        .btn-pdf:hover {
            background-color: #b91c1c;
        }

        /* Form Steps Styling */
        .form-step {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-out;
        }
        .form-step.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress Dots */
        .progress-dots {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 0.75rem;
        }
        .progress-dot {
            width: 12px;
            height: 12px;
            background-color: #d1d5db;
            border-radius: 50%;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .progress-dot.active {
            background-color: #3b82f6;
            transform: scale(1.2);
        }
        .progress-dot.completed {
            background-color: #10b981;
        }

        /* Footer Styling */
        footer {
            background-color: #1a202c; /* Darker footer */
            color: #cbd5e1; /* Lighter text color */
            padding: 1.5rem 2rem;
            text-align: center;
            margin-top: auto; /* Push footer to the bottom */
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
        }
        footer p {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        footer a {
            color: #60a5fa; /* Light blue for links */
            text-decoration: none;
            transition: color 0.2s ease-in-out;
        }
        footer a:hover {
            color: #3b82f6;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.75rem;
            }
            .container {
                padding: 1rem;
                margin: 1rem auto;
            }
            .grid-cols-1-md-2 {
                grid-template-columns: 1fr;
            }
            #loadingTasks {
                width: 95%;
            }
            .social-share-buttons button {
                width: calc(50% - 1rem);
                margin: 0.5rem 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-700">
    <header>
        <h1>وكيل EhabGM للتسويق الذكي (EMIA)</h1>
    </header>

    <div id="loadingOverlay" class="hidden">
        <div class="loading-animation"></div>
        <h2 class="text-3xl font-bold text-blue-700 mb-4">أهلاً بك في وكيل EhabGM للتسويق الذكي!</h2>
        <div class="loading-message-container">
            <div id="dynamicLoadingMessage" class="loading-message"></div>
        </div>
        <ul id="loadingTasks">
            <!-- Tasks will be dynamically added here -->
        </ul>
    </div>

    <main>
        <div class="container">
            <!-- Progress Dots -->
            <div class="progress-dots" id="progressDots">
                <span class="progress-dot active" id="dot-0"></span>
                <span class="progress-dot" id="dot-1"></span>
                <span class="progress-dot" id="dot-2"></span>
                <span class="progress-dot" id="dot-3"></span>
                <span class="progress-dot" id="dot-4"></span>
            </div>

            <form id="marketingForm" class="space-y-6">
                <!-- Step 1: Brand Info -->
                <div class="form-step active" id="step-0">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">الخطوة 1: معلومات البراند الأساسية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="brandName" class="block text-sm font-medium text-gray-700 mb-1">اسم العميل أو البراند:</label>
                            <input type="text" id="brandName" name="brandName" placeholder="مثال: متجر الأناقة للملابس" class="block w-full" required>
                        </div>
                        <div>
                            <label for="businessType" class="block text-sm font-medium text-gray-700 mb-1">نوع النشاط التجاري:</label>
                            <input type="text" id="businessType" name="businessType" placeholder="مثال: تجارة إلكترونية للملابس النسائية" class="block w-full" required>
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="button" class="btn-primary" id="nextStepBtn-0">التالي <i class="fas fa-arrow-left mr-2"></i></button>
                    </div>
                </div>

                <!-- Step 2: Service/Product & Budget -->
                <div class="form-step" id="step-1">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">الخطوة 2: وصف الخدمة والميزانية</h3>
                    <div>
                        <label for="serviceDescription" class="block text-sm font-medium text-gray-700 mb-1">وصف الخدمة أو المنتج/الهدف:</label>
                        <textarea id="serviceDescription" name="serviceDescription" rows="4" placeholder="مثال: بيع فساتين سهرة عصرية بجودة عالية وأسعار تنافسية، الهدف هو زيادة المبيعات بنسبة 30% في الربع القادم." class="block w-full" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">الميزانية المتاحة (رقم فقط، اختياري):</label>
                            <input type="text" id="budget" name="budget" placeholder="مثال: 1000" class="block w-full">
                        </div>
                        <div>
                            <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">العملة:</label>
                            <select id="currency" name="currency" class="block w-full">
                                <option value="USD">دولار أمريكي (USD)</option>
                                <option value="EGP">جنيه مصري (EGP)</option>
                                <option value="SAR">ريال سعودي (SAR)</option>
                                <option value="AED">درهم إماراتي (AED)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" class="btn-secondary" id="prevStepBtn-1"><i class="fas fa-arrow-right ml-2"></i> السابق</button>
                        <button type="button" class="btn-primary" id="nextStepBtn-1">التالي <i class="fas fa-arrow-left mr-2"></i></button>
                    </div>
                </div>

                <!-- Step 3: Location & Contact -->
                <div class="form-step" id="step-2">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">الخطوة 3: الموقع ووسيلة التواصل</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700 mb-1">الدولة/المحافظة (لتحديد الجمهور المستهدف):</label>
                            <input type="text" id="location" name="location" placeholder="مثال: مصر، القاهرة / السعودية، الرياض / أونلاين" class="block w-full" required>
                        </div>
                        <div>
                            <label for="contactMethod" class="block text-sm font-medium text-gray-700 mb-1">وسيلة التواصل المفضلة:</label>
                            <input type="text" id="contactMethod" name="contactMethod" placeholder="مثال: 01012345678 أو info@brand.com" class="block w-full">
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" class="btn-secondary" id="prevStepBtn-2"><i class="fas fa-arrow-right ml-2"></i> السابق</button>
                        <button type="button" class="btn-primary" id="nextStepBtn-2">التالي <i class="fas fa-arrow-left mr-2"></i></button>
                    </div>
                </div>

                <!-- Step 4: Target Audience & Logo -->
                <div class="form-step" id="step-3">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">الخطوة 4: الجمهور المستهدف والشعار</h3>
                    <div>
                        <label for="targetAudienceInput" class="block text-sm font-medium text-gray-700 mb-1">الجمهور المستهدف (اختياري، لو لديك معلومات محددة):</label>
                        <textarea id="targetAudienceInput" name="targetAudienceInput" rows="2" placeholder="مثال: نساء من 25-45 سنة، مهتمات بالموضة والأزياء، يعشن في المدن الكبرى." class="block w-full"></textarea>
                    </div>
                    <div class="mt-6">
                        <label for="logoUpload" class="block text-sm font-medium text-gray-700 mb-2">شعار البراند (اختياري، سيظهر في التقرير):</label>
                        <div class="logo-upload-section" id="logoUploadArea">
                            <input type="file" id="logoUpload" name="logoUpload" accept="image/*" class="hidden">
                            <p class="text-gray-500">اسحب الشعار هنا أو انقر للتحميل</p>
                            <img id="logoPreview" class="logo-preview hidden" src="#" alt="معاينة الشعار">
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" class="btn-secondary" id="prevStepBtn-3"><i class="fas fa-arrow-right ml-2"></i> السابق</button>
                        <button type="button" class="btn-primary" id="nextStepBtn-3">التالي <i class="fas fa-arrow-left mr-2"></i></button>
                    </div>
                </div>

                <!-- Step 5: Review and Generate -->
                <div class="form-step" id="step-4">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">الخطوة 5: مراجعة وتوليد التقرير</h3>
                    <div class="report-section mb-6">
                        <h4 class="text-xl font-semibold text-gray-800 mb-2">ملخص بياناتك:</h4>
                        <p><strong>اسم البراند:</strong> <span id="reviewBrandName"></span></p>
                        <p><strong>نوع النشاط:</strong> <span id="reviewBusinessType"></span></p>
                        <p><strong>وصف الخدمة/الهدف:</strong> <span id="reviewServiceDescription"></span></p>
                        <p><strong>الميزانية:</strong> <span id="reviewBudget"></span> <span id="reviewCurrency"></span></p>
                        <p><strong>الموقع:</strong> <span id="reviewLocation"></span></p>
                        <p><strong>التواصل:</strong> <span id="reviewContactMethod"></span></p>
                        <p><strong>الجمهور المستهدف:</strong> <span id="reviewTargetAudience"></span></p>
                        <div class="text-center mt-4" id="reviewLogoContainer">
                            <img id="reviewLogoPreview" class="logo-preview mx-auto hidden" src="#" alt="شعار البراند">
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button type="button" class="btn-secondary" id="prevStepBtn-4"><i class="fas fa-arrow-right ml-2"></i> السابق</button>
                        <button type="submit" class="btn-primary" id="generateReportFinalBtn">توليد التقرير الشامل <i class="fas fa-magic mr-2"></i></button>
                    </div>
                </div>
            </form>

            <div id="reportOutput" class="mt-10 p-6 bg-white rounded-xl shadow-lg hidden">
                <div class="flex flex-wrap items-center justify-between mb-6 border-b-2 border-blue-600 pb-4">
                    <h2 class="text-2xl font-bold text-blue-700 mb-2 md:mb-0">التقرير التسويقي الشامل</h2>
                    <div class="flex flex-wrap justify-center md:justify-end gap-2">
                        <button id="copyReportBtn" class="btn-secondary flex items-center">
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2M8 8H6a2 2 0 00-2 2v2m8-8v8m0 0H8m4 0h2"></path></svg>
                            نسخ التقرير
                        </button>
                        <button id="printPdfBtn" class="btn-pdf flex items-center">
                            <i class="fas fa-file-pdf ml-2"></i> طباعة كـ PDF
                        </button>
                    </div>
                </div>

                <div id="reportContent" class="report-content text-lg leading-relaxed">
                    <!-- AI-generated content will be inserted here -->
                </div>

                <div class="mt-8 social-share-buttons text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">شارك هذا التقرير أو التطبيق!</h3>
                    <button class="btn-whatsapp" id="shareWhatsappBtn">
                        <i class="fab fa-whatsapp"></i> مشاركة عبر واتساب
                    </button>
                    <button class="btn-facebook" id="shareFacebookBtn">
                        <i class="fab fa-facebook"></i> مشاركة عبر فيسبوك
                    </button>
                    <button class="btn-twitter" id="shareTwitterBtn">
                        <i class="fab fa-twitter"></i> مشاركة عبر X
                    </button>
                    <button class="btn-linkedin" id="shareLinkedInBtn">
                        <i class="fab fa-linkedin-in"></i> مشاركة عبر لينكدإن
                    </button>
                </div>

                <div id="copySuccessMessage" class="mt-4 p-3 bg-green-100 text-green-700 rounded-md text-center hidden">
                    تم نسخ التقرير بنجاح! يمكنك الآن لصقه في مستند Google Docs أو Word.
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2023 وكيل EhabGM للتسويق الذكي (EMIA). جميع الحقوق محفوظة.</p>
        <p class="mb-2 font-semibold text-red-400">هذه الخدمة متاحة مجانًا لفترة محدودة!</p>
        <p>للتواصل مع المطور أو للاستفسارات:</p>
        <a href="https://wa.me/201022679250" target="_blank" class="text-blue-400 hover:text-blue-200 inline-flex items-center justify-center">
            <i class="fab fa-whatsapp ml-2"></i> تواصل عبر واتساب (01022679250)
        </a>
    </footer>

    <script type="module">
        // Global variables for Firebase configuration and app ID (not used in this specific version for AI calls)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const marketingForm = document.getElementById('marketingForm');
        const generateBtn = document.getElementById('generateReportFinalBtn'); // Renamed for clarity
        const reportOutput = document.getElementById('reportOutput');
        const reportContent = document.getElementById('reportContent');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const printPdfBtn = document.getElementById('printPdfBtn');
        const copySuccessMessage = document.getElementById('copySuccessMessage');
        const logoUpload = document.getElementById('logoUpload');
        const logoUploadArea = document.getElementById('logoUploadArea');
        const logoPreview = document.getElementById('logoPreview');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const dynamicLoadingMessage = document.getElementById('dynamicLoadingMessage');
        const loadingTasksList = document.getElementById('loadingTasks');
        const progressDotsContainer = document.getElementById('progressDots');

        let uploadedLogoBase64 = null;
        let myBudgetChart, myGrowthChart, myAudienceChart, myContentChart, myCustomerJourneyChart; // To store Chart.js instances
        let messageInterval; // To control the dynamic loading messages
        let activeTaskIndex = -1; // To track the currently active task
        let currentStep = 0; // Current step of the form

        // Array of engaging loading messages
        const loadingMessages = [
            "جاري تحليل بيانات السوق بدقة فائقة...",
            "نعمل على صياغة هوية براندك الفريدة...",
            "نقوم بإنشاء منشورات تسويقية جذابة خصيصًا لك...",
            "جاري تقدير أفضل ميزانية إعلانية لتحقيق أهدافك...",
            "نبتكر أفكار تصميمية مبدعة لعلامتك التجارية...",
            "نضع اللمسات الأخيرة على خطتك التسويقية المتكاملة...",
            "نستكشف أفضل استراتيجيات SEO والبريد الإلكتروني لنموك...",
            "نحسب العوائد المتوقعة لضمان نجاح استثماراتك...",
            "الذكاء الاصطناعي يعمل بجد لتقديم أفضل النتائج!",
            "قريبًا سيكون تقريرك الشامل جاهزًا..."
        ];
        let currentMessageIndex = 0;

        // Tasks for the loading screen (aligned with AI generation steps)
        const tasks = [
            "تهيئة النظام وجمع البيانات الأولية", // 0
            "صياغة الهوية التعريفية للبراند",      // 1
            "تحليل الجمهور المستهدف بدقة",         // 2
            "كتابة 5 منشورات تسويقية مبتكرة",       // 3
            "اقتراح ميزانية ومدد الإعلانات الممولة",// 4
            "تقديم أفكار تصميم وابتكار",           // 5
            "بناء خطة تسويقية مختصرة وكاملة",       // 6
            "توليد استراتيجيات SEO والبريد الإلكتروني",// 7
            "تحليل عائد الاستثمار والعوائد المتوقعة",// 8
            "إنشاء الرسوم البيانية التحليلية",      // 9
            "تجميع التقرير النهائي وعرضه"          // 10
        ];

        // --- Form Navigation Logic ---
        const formSteps = document.querySelectorAll('.form-step');
        const totalSteps = formSteps.length;

        function showStep(stepNum) {
            formSteps.forEach((step, index) => {
                step.classList.remove('active');
                if (index === stepNum) {
                    step.classList.add('active');
                }
            });
            updateProgressDots(stepNum);
        }

        function updateProgressDots(stepNum) {
            const dots = progressDotsContainer.children;
            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.remove('active', 'completed');
                if (i < stepNum) {
                    dots[i].classList.add('completed');
                } else if (i === stepNum) {
                    dots[i].classList.add('active');
                }
            }
        }

        function validateStep(stepNum) {
            let isValid = true;
            const currentStepElement = document.getElementById(`step-${stepNum}`);
            const requiredInputs = currentStepElement.querySelectorAll('[required]');

            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.style.borderColor = 'red'; // Simple visual feedback
                } else {
                    input.style.borderColor = '#d1d5db';
                }
            });
            if (!isValid) {
                alert('الرجاء ملء جميع الحقول المطلوبة في هذه الخطوة.');
            }
            return isValid;
        }

        // Attach event listeners for navigation buttons
        document.querySelectorAll('[id^="nextStepBtn-"]').forEach(button => {
            button.addEventListener('click', () => {
                const stepIndex = parseInt(button.id.split('-')[1]);
                if (validateStep(stepIndex)) {
                    currentStep++;
                    showStep(currentStep);
                }
            });
        });

        document.querySelectorAll('[id^="prevStepBtn-"]').forEach(button => {
            button.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
            });
        });

        // Initial display
        showStep(currentStep);

        // --- Loading Overlay & Task Logic ---
        function updateLoadingMessage() {
            dynamicLoadingMessage.textContent = loadingMessages[currentMessageIndex];
            currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
        }

        function initializeLoadingTasks() {
            loadingTasksList.innerHTML = '';
            tasks.forEach((task, index) => {
                const listItem = document.createElement('li');
                listItem.id = `task-${index}`;
                listItem.innerHTML = `<span class="task-icon"><i class="fas fa-spinner fa-spin"></i></span> ${task}`;
                loadingTasksList.appendChild(listItem);
            });
            activeTaskIndex = -1; // Reset active task
        }

        function completeTask(index) {
            if (activeTaskIndex !== -1) {
                const prevTaskItem = document.getElementById(`task-${activeTaskIndex}`);
                if (prevTaskItem) {
                    prevTaskItem.classList.remove('active');
                    prevTaskItem.classList.add('completed');
                    prevTaskItem.querySelector('.task-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                }
            }
            activeTaskIndex = index;
            const currentTaskItem = document.getElementById(`task-${activeTaskIndex}`);
            if (currentTaskItem) {
                currentTaskItem.classList.add('active');
                currentTaskItem.querySelector('.task-icon').innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Ensure it's spinning for active
            }
        }

        // --- Logo Upload Logic ---
        logoUploadArea.addEventListener('click', () => logoUpload.click());

        logoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoPreview.src = e.target.result;
                    logoPreview.classList.remove('hidden');
                    uploadedLogoBase64 = e.target.result; // Store base64 for report
                    document.getElementById('reviewLogoPreview').src = e.target.result;
                    document.getElementById('reviewLogoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                logoPreview.classList.add('hidden');
                logoPreview.src = '#';
                uploadedLogoBase64 = null;
                document.getElementById('reviewLogoPreview').classList.add('hidden');
                document.getElementById('reviewLogoPreview').src = '#';
            }
        });

        // --- Populate Review Step ---
        function populateReviewStep() {
            document.getElementById('reviewBrandName').textContent = document.getElementById('brandName').value;
            document.getElementById('reviewBusinessType').textContent = document.getElementById('businessType').value;
            document.getElementById('reviewServiceDescription').textContent = document.getElementById('serviceDescription').value;
            document.getElementById('reviewBudget').textContent = document.getElementById('budget').value || 'غير محددة';
            document.getElementById('reviewCurrency').textContent = document.getElementById('currency').value;
            document.getElementById('reviewLocation').textContent = document.getElementById('location').value;
            document.getElementById('reviewContactMethod').textContent = document.getElementById('contactMethod').value || 'غير محددة';
            document.getElementById('reviewTargetAudience').textContent = document.getElementById('targetAudienceInput').value || 'غير محددة بشكل دقيق';

            if (uploadedLogoBase64) {
                document.getElementById('reviewLogoPreview').src = uploadedLogoBase64;
                document.getElementById('reviewLogoPreview').classList.remove('hidden');
            } else {
                document.getElementById('reviewLogoPreview').classList.add('hidden');
            }
        }

        // Attach event listener for the final generate button
        marketingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Populate review step before starting generation (in case user jumps back)
            populateReviewStep();

            // Destroy existing charts if they exist
            if (myBudgetChart) myBudgetChart.destroy();
            if (myGrowthChart) myGrowthChart.destroy();
            if (myAudienceChart) myAudienceChart.destroy();
            if (myContentChart) myContentChart.destroy();
            if (myCustomerJourneyChart) myCustomerJourneyChart.destroy();

            // Show loading overlay and start message cycling
            loadingOverlay.classList.remove('hidden');
            initializeLoadingTasks(); // Initialize tasks list
            updateLoadingMessage(); // Display first message immediately
            messageInterval = setInterval(updateLoadingMessage, 4000); // Change message every 4 seconds (matches CSS animation)

            // Disable button and show loading spinner (redundant if overlay is full screen, but good for consistency)
            generateBtn.disabled = true;
            generateBtn.innerHTML = 'جاري التوليد... <i class="fas fa-spinner fa-spin mr-2"></i>';

            // Hide report output and clear content
            reportOutput.classList.add('hidden');
            copySuccessMessage.classList.add('hidden');
            reportContent.innerHTML = '';

            const brandName = document.getElementById('brandName').value;
            const businessType = document.getElementById('businessType').value;
            const serviceDescription = document.getElementById('serviceDescription').value;
            const budget = parseFloat(document.getElementById('budget').value) || 0;
            const currency = document.getElementById('currency').value;
            const contactMethod = document.getElementById('contactMethod').value;
            const location = document.getElementById('location').value;
            const targetAudienceInput = document.getElementById('targetAudienceInput').value;

            const promptData = {
                brandName,
                businessType,
                serviceDescription,
                budget: budget > 0 ? `${budget} ${currency}` : 'غير محددة',
                rawBudget: budget,
                currency,
                contactMethod,
                location,
                targetAudienceInput: targetAudienceInput || 'غير محددة بشكل دقيق، يرجى تحليلها بناءً على نوع النشاط.',
            };

            let generatedReportHTML = '';

            // Add logo to the report if uploaded
            if (uploadedLogoBase64) {
                generatedReportHTML += `<div class="text-center mb-8">
                                            <img src="${uploadedLogoBase64}" alt="شعار البراند" class="logo-preview mx-auto" style="max-width: 200px; max-height: 200px;">
                                        </div>`;
            }

            generatedReportHTML += `
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-8">التقرير التسويقي الشامل لـ ${brandName}</h1>
                <div class="report-section">
                    <h3>معلومات البراند الأساسية</h3>
                    <p><strong>اسم البراند:</strong> ${brandName}</p>
                    <p><strong>نوع النشاط التجاري:</strong> ${businessType}</p>
                    <p><strong>وصف الخدمة/الهدف:</strong> ${serviceDescription}</p>
                    <p><strong>الميزانية المتاحة:</strong> ${promptData.budget}</p>
                    <p><strong>وسيلة التواصل:</strong> ${contactMethod}</p>
                    <p><strong>مكان النشاط:</strong> ${location}</p>
                </div>
            `;

            try {
                // Function to call Gemini API
                const callGemini = async (prompt) => {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyB6jnqtwtZ-p2G_8D9KMhvhlNywwLhw3HQ"; // Canvas will provide this at runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure or no content.");
                    }
                };

                // --- Generate Charts First (Illustrative Data) ---
                const chartsHTML = `
                    <div class="report-section" id="chartsSection">
                        <h3>1. التحليلات والرسوم البيانية</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">توزيع الميزانية المقترحة</h4>
                                <div class="chart-container">
                                    <canvas id="budgetDistributionChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">توقعات النمو/العوائد الشهرية (توضيحي)</h4>
                                <div class="chart-container">
                                    <canvas id="growthProjectionChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">تركيبة الجمهور المستهدف (توضيحي)</h4>
                                <div class="chart-container">
                                    <canvas id="audienceDemographicsChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">أداء المحتوى حسب النوع (توضيحي)</h4>
                                <div class="chart-container">
                                    <canvas id="contentPerformanceChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">مراحل رحلة العميل (توضيحي)</h4>
                                <div class="chart-container">
                                    <canvas id="customerJourneyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                generatedReportHTML += chartsHTML;
                completeTask(0); // Task 0: Initialize and collect data

                // --- 2. بناء الهوية التعريفية للبراند ---
                let brandIdentityPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - مكان النشاط: ${location}

                يرجى صياغة:
                1.  **الرؤية (Vision):** جملة ملهمة تعبر عن الطموح المستقبلي للبراند.
                2.  **الرسالة (Mission):** ما يقدمه البراند حاليًا وكيف يحقق رؤيته.
                3.  **القيم الأساسية (Core Values):** 3-5 قيم تمثل جوهر البراند.
                4.  **نقاط البيع الفريدة (Unique Selling Proposition - USP):** ما يميز البراند عن منافسيه.
                5.  **قصة البراند (Brand Story):** فقرة قصيرة وجذابة عن نشأة البراند أو فلسفته.

                صيغة الإجابة تكون كالتالي:
                **الرؤية:** [الرؤية هنا]
                **الرسالة:** [الرسالة هنا]
                **القيم الأساسية:**
                - [قيمة 1]
                - [قيمة 2]
                - [قيمة 3]
                **نقاط البيع الفريدة:** [USP هنا]
                **قصة البراند:** [القصة هنا]
                `;
                const brandIdentity = await callGemini(brandIdentityPrompt);
                generatedReportHTML += `<div class="report-section"><h3>2. الهوية التعريفية للبراند</h3>${brandIdentity.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(1); // Task 1: Brand Identity

                // --- 3. تحليل الجمهور المستهدف ---
                let audienceAnalysisPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - مكان النشاط: ${location}
                - الجمهور المستهدف المدخل: ${promptData.targetAudienceInput}

                يرجى تحليل الجمهور المستهدف بالتفصيل، مع التركيز على:
                1.  **الخصائص الديموغرافية:** (السن، الجنس، المستوى التعليمي، الدخل، الحالة الاجتماعية، الموقع الجغرافي).
                2.  **الخصائص النفسية/السلوكية:** (الاهتمامات، الهوايات، القيم، نمط الحياة، التحديات/نقاط الألم، الدوافع للشراء، السلوك الشرائي، المنصات المفضلة).
                3.  **الاحتياجات والرغبات:** ما الذي يبحث عنه هذا الجمهور وكيف يمكن للبراند أن يلبي هذه الاحتياجات.

                صيغة الإجابة تكون كالتالي:
                **الخصائص الديموغرافية:**
                - السن:
                - الجنس:
                - ...
                **الخصائص النفسية/السلوكية:**
                - الاهتمامات:
                - الهوايات:
                - ...
                **الاحتياجات والرغبات:**
                - ...
                `;
                const audienceAnalysis = await callGemini(audienceAnalysisPrompt);
                generatedReportHTML += `<div class="report-section"><h3>3. تحليل الجمهور المستهدف</h3>${audienceAnalysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(2); // Task 2: Audience Analysis

                // --- 4. كتابة 5 منشورات تسويقية ---
                let postsPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الجمهور المستهدف: ${audienceAnalysis} (ملخص من التحليل السابق)

                يرجى كتابة 5 منشورات تسويقية متنوعة (مثل: ترويجية، تفاعلية، تثقيفية، إعلان عرض، تحفيزية) لمنصات التواصل الاجتماعي (فيسبوك/انستجرام). لكل منشور:
                - يجب أن يحتوي على نص جذاب.
                - اقتراح صورة/فيديو مناسب.
                - Call to Action (CTA) واضحة.
                - 3-5 هاشتاجات ذات صلة.

                صيغة الإجابة تكون كالتالي:
                **المنشور 1 (نوع المنشور):**
                النص: [نص المنشور]
                اقتراح مرئي: [وصف الصورة/الفيديو]
                CTA: [دعوة للعمل]
                الهاشتاجات: [هاشتاج1] [هاشتاج2] ...

                **المنشور 2 (نوع المنشور):**
                ...
                `;
                const marketingPosts = await callGemini(postsPrompt);
                generatedReportHTML += `<div class="report-section"><h3>4. 5 منشورات تسويقية مقترحة</h3>${marketingPosts.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(3); // Task 3: Marketing Posts

                // --- 5. اقتراح ميزانية ومدد للإعلانات الممولة ---
                let budgetProposalPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الميزانية المتاحة: ${promptData.rawBudget > 0 ? promptData.rawBudget + ' ' + promptData.currency : 'غير محددة'}
                - الجمهور المستهدف: ${audienceAnalysis} (ملخص من التحليل السابق)
                - مكان النشاط: ${location}

                يرجى تقديم اقتراح لميزانية ومدد للإعلانات الممولة على (فيسبوك، إنستجرام، تيك توك). يجب أن يتضمن الاقتراح:
                1.  **أهداف الحملة:** (مثال: زيادة الوعي، زيادة المبيعات، جمع العملاء المحتملين).
                2.  **توزيع الميزانية المقترح:** على المنصات المختلفة (فيسبوك، انستجرام، تيك توك) مع نسبة لكل منصة.
                3.  **المدة المقترحة للحملة:** (مثال: شهر، 3 أشهر).
                4.  **توقعات الأداء (KPIs):** (مثال: عدد مرات الوصول، عدد النقرات، عدد العملاء المحتملين، تكلفة النقرة).
                5.  **ملاحظات إضافية:** أي نصائح لتحسين أداء الحملة.

                صيغة الإجابة تكون كالتالي:
                **أهداف الحملة:**
                - [هدف 1]
                - [هدف 2]
                **توزيع الميزانية المقترح (بناءً على ميزانية ${promptData.budget}):**
                - فيسبوك/انستجرام: [نسبة مئوية]% ([المبلغ المقدر])
                - تيك توك: [نسبة مئوية]% ([المبلغ المقدر])
                **المدة المقترحة للحملة:** [المدة]
                **توقعات الأداء (KPIs):**
                - [KPI 1]: [قيمة متوقعة]
                - [KPI 2]: [قيمة متوقعة]
                **ملاحظات إضافية:**
                - ...
                `;
                const budgetProposal = await callGemini(budgetProposalPrompt);
                generatedReportHTML += `<div class="report-section"><h3>5. اقتراح ميزانية ومدد للإعلانات الممولة</h3>${budgetProposal.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(4); // Task 4: Budget Proposal

                // --- 6. تقديم أفكار تصميم وابتكار ---
                let designIdeasPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الهوية التعريفية للبراند: ${brandIdentity} (ملخص من التحليل السابق)
                - الجمهور المستهدف: ${audienceAnalysis} (ملخص من التحليل السابق)

                يرجى تقديم أفكار تصميم وابتكار للهوية البصرية والمحتوى المرئي للبراند، مع التركيز على:
                1.  **الألوان المقترحة:** (لوحة ألوان أساسية وثانوية مع دلالاتها).
                2.  **الخطوط المقترحة:** (خطوط للعناوين وخطوط للنصوص).
                3.  **أنماط التصميم:** (مثال: عصري، كلاسيكي، بسيط، جريء، مرح).
                4.  **أفكار لمحتوى مرئي مبتكر:** (مثال: أنواع صور/فيديوهات، استخدام الرسوم المتحركة، أفكار لحملات بصرية).
                5.  **أفكار لتصميم الشعار:** (وصف عام لشكل الشعار أو رموزه).

                صيغة الإجابة تكون كالتالي:
                **الألوان المقترحة:**
                - [لون 1] (#HEXCODE): [دلالته]
                - [لون 2] (#HEXCODE): [دلالته]
                **الخطوط المقترحة:**
                - للعناوين: [اسم الخط]
                - للنصوص: [اسم الخط]
                **أنماط التصميم:**
                - ...
                **أفكار لمحتوى مرئي مبتكر:**
                - ...
                **أفكار لتصميم الشعار:**
                - ...
                `;
                const designIdeas = await callGemini(designIdeasPrompt);
                generatedReportHTML += `<div class="report-section"><h3>6. أفكار تصميم وابتكار</h3>${designIdeas.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(5); // Task 5: Design Ideas

                // --- 7. بناء خطة تسويقية مختصرة وكاملة ---
                let marketingPlanPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الهوية التعريفية للبراند: ${brandIdentity}
                - الجمهور المستهدف: ${audienceAnalysis}
                - اقتراح الميزانية والإعلانات: ${budgetProposal}
                - مكان النشاط: ${location}

                يرجى بناء خطة تسويقية مختصرة وكاملة، مع التركيز على:
                1.  **أهداف الخطة:** (SMART Goals).
                2.  **المراحل الرئيسية:** (مثال: مرحلة التحضير، مرحلة الإطلاق، مرحلة المتابعة والتحسين).
                3.  **القنوات التسويقية المقترحة:** (مثل: السوشيال ميديا، الإعلانات المدفوعة، التسويق بالمحتوى، البريد الإلكتروني، SEO).
                4.  **الجدول الزمني المقترح:** (تقسيم المهام على أسابيع أو أشهر).
                5.  **مؤشرات الأداء الرئيسية (KPIs) للخطة ككل:** (كيف سيتم قياس النجاح).

                صيغة الإجابة تكون كالتالي:
                **أهداف الخطة:**
                - [هدف 1]
                - [هدف 2]
                **المراحل الرئيسية والمهام:**
                - **مرحلة التحضير:**
                    - [مهمة 1]
                    - [مهمة 2]
                - **مرحلة الإطلاق:**
                    - ...
                **القنوات التسويقية المقترحة:**
                - ...
                **الجدول الزمني المقترح (مثال لـ 3 أشهر):**
                - الشهر الأول:
                - الشهر الثاني:
                - الشهر الثالث:
                **مؤشرات الأداء الرئيسية (KPIs) للخطة:**
                - ...
                `;
                const marketingPlan = await callGemini(marketingPlanPrompt);
                generatedReportHTML += `<div class="report-section"><h3>7. خطة تسويقية مختصرة وكاملة</h3>${marketingPlan.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(6); // Task 6: Marketing Plan

                // --- 8. استراتيجية SEO وEmail Marketing ---
                let seoEmailPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الجمهور المستهدف: ${audienceAnalysis}
                - مكان النشاط: ${location}

                يرجى تقديم اقتراحات لاستراتيجية تحسين محركات البحث (SEO) والتسويق عبر البريد الإلكتروني (Email Marketing):
                1.  **استراتيجية SEO:**
                    - اقتراح 5-7 كلمات مفتاحية رئيسية محتملة.
                    - نصائح عامة لتحسين الموقع لمحركات البحث (On-page SEO).
                2.  **استراتيجية التسويق عبر البريد الإلكتروني:**
                    - أفكار لأنواع رسائل البريد الإلكتروني (مثال: رسائل ترحيب، عروض، نشرات إخبارية).
                    - نصائح لزيادة قائمة المشتركين.

                صيغة الإجابة تكون كالتالي:
                **استراتيجية تحسين محركات البحث (SEO):**
                - **الكلمات المفتاحية المقترحة:**
                    - [كلمة مفتاحية 1]
                    - [كلمة مفتاحية 2]
                - **نصائح عامة لتحسين الموقع:**
                    - ...
                **استراتيجية التسويق عبر البريد الإلكتروني (Email Marketing):**
                - **أنواع الرسائل المقترحة:**
                    - ...
                - **نصائح لزيادة قائمة المشتركين:**
                    - ...
                `;
                const seoEmailStrategy = await callGemini(seoEmailPrompt);
                generatedReportHTML += `<div class="report-section"><h3>8. استراتيجية SEO والتسويق عبر البريد الإلكتروني</h3>${seoEmailStrategy.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(7); // Task 7: SEO & Email

                // --- 9. تحليل عائد الاستثمار (ROI) وتوقعات العوائد ---
                let roiAnalysisPrompt = `بناءً على المعلومات التالية لبراند:
                - اسم البراند: ${brandName}
                - نوع النشاط التجاري: ${businessType}
                - وصف الخدمة/الهدف: ${serviceDescription}
                - الميزانية المتاحة: ${promptData.rawBudget > 0 ? promptData.rawBudget + ' ' + promptData.currency : 'غير محددة'}
                - اقتراح الميزانية والإعلانات: ${budgetProposal}
                - خطة التسويق: ${marketingPlan}
                - مكان النشاط: ${location}

                يرجى تقديم تحليل مبدئي لعائد الاستثمار (ROI) والعوائد المتوقعة على الأقل احتمال، مع التركيز على:
                1.  **توقعات العائد على الاستثمار (ROI):** تقدير تقريبي (كنسبة مئوية أو وصف) بناءً على الميزانية والأهداف.
                2.  **تحليل نقطة التعادل (Break-even Point):** متى يمكن للبراند أن يبدأ بتغطية تكاليف التسويق.
                3.  **توقعات نمو الوعي بالعلامة التجارية:** (مثال: زيادة في عدد المتابعين، الإشارة للبراند).
                4.  **توقعات المبيعات/العملاء المحتملين:** (تقدير تقريبي).
                5.  **ملاحظات حول المخاطر والافتراضات:** (ما هي العوامل التي قد تؤثر على هذه التوقعات).

                صيغة الإجابة تكون كالتالي:
                **توقعات العائد على الاستثمار (ROI):**
                - ...
                **تحليل نقطة التعادل:**
                - ...
                **توقعات نمو الوعي بالعلامة التجارية:**
                - ...
                **توقعات المبيعات/العملاء المحتملين:**
                - ...
                **ملاحظات حول المخاطر والافتراضات:**
                - ...
                `;
                const roiAnalysis = await callGemini(roiAnalysisPrompt);
                generatedReportHTML += `<div class="report-section"><h3>9. تحليل عائد الاستثمار (ROI) والعوائد المتوقعة</h3>${roiAnalysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>`;
                completeTask(8); // Task 8: ROI Analysis

                reportContent.innerHTML = generatedReportHTML;
                reportOutput.classList.remove('hidden');

                // --- Generate Charts ---
                // Data for charts (illustrative, based on input budget and general assumptions)
                const budgetAllocation = {
                    facebookInstagram: promptData.rawBudget * 0.5,
                    tiktok: promptData.rawBudget * 0.3,
                    other: promptData.rawBudget * 0.2
                };

                // Budget Distribution Chart
                const budgetCtx = document.getElementById('budgetDistributionChart').getContext('2d');
                myBudgetChart = new Chart(budgetCtx, {
                    type: 'pie',
                    data: {
                        labels: ['فيسبوك/انستجرام', 'تيك توك', 'أخرى/متنوعة'],
                        datasets: [{
                            data: [budgetAllocation.facebookInstagram, budgetAllocation.tiktok, budgetAllocation.other],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)', // Blue
                                'rgba(239, 68, 68, 0.8)',  // Red
                                'rgba(16, 185, 129, 0.8)'  // Green
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(239, 68, 68, 1)',
                                'rgba(16, 185, 129, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            title: {
                                display: false,
                                text: 'توزيع الميزانية المقترحة'
                            }
                        }
                    }
                });

                // Growth Projection Chart (Illustrative)
                const growthCtx = document.getElementById('growthProjectionChart').getContext('2d');
                const initialValue = promptData.rawBudget > 0 ? promptData.rawBudget * 2 : 1000; // Example starting point
                myGrowthChart = new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: ['الشهر 1', 'الشهر 2', 'الشهر 3', 'الشهر 4', 'الشهر 5', 'الشهر 6'],
                        datasets: [{
                            label: `نمو العوائد المتوقعة (${currency})`,
                            data: [
                                initialValue,
                                initialValue * 1.1,
                                initialValue * 1.25,
                                initialValue * 1.4,
                                initialValue * 1.55,
                                initialValue * 1.7
                            ],
                            borderColor: 'rgba(139, 92, 246, 0.8)', // Purple
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            title: {
                                display: false,
                                text: 'توقعات النمو/العوائد الشهرية'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: `القيمة (${currency})`,
                                    font: {
                                        family: 'Inter',
                                    }
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            }
                        }
                    }
                });

                // Audience Demographics Chart (Illustrative)
                const audienceCtx = document.getElementById('audienceDemographicsChart').getContext('2d');
                myAudienceChart = new Chart(audienceCtx, {
                    type: 'bar',
                    data: {
                        labels: ['18-24', '25-34', '35-44', '45-54', '55+'],
                        datasets: [{
                            label: 'النسبة المئوية للجمهور',
                            data: [15, 35, 25, 15, 10], // Illustrative percentages
                            backgroundColor: [
                                'rgba(251, 191, 36, 0.8)', // Yellow
                                'rgba(52, 211, 153, 0.8)', // Teal
                                'rgba(99, 102, 241, 0.8)', // Indigo
                                'rgba(249, 115, 22, 0.8)', // Orange
                                'rgba(165, 180, 252, 0.8)' // Light Indigo
                            ],
                            borderColor: [
                                'rgba(251, 191, 36, 1)',
                                'rgba(52, 211, 153, 1)',
                                'rgba(99, 102, 241, 1)',
                                'rgba(249, 115, 22, 1)',
                                'rgba(165, 180, 252, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            title: {
                                display: false,
                                text: 'تركيبة الجمهور المستهدف'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'النسبة المئوية',
                                    font: {
                                        family: 'Inter',
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'الفئة العمرية',
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            }
                        }
                    }
                });

                // Content Performance Chart (Illustrative)
                const contentCtx = document.getElementById('contentPerformanceChart').getContext('2d');
                myContentChart = new Chart(contentCtx, {
                    type: 'bar',
                    data: {
                        labels: ['منشورات ترويجية', 'منشورات تثقيفية', 'منشورات تفاعلية', 'إعلانات عروض'],
                        datasets: [{
                            label: 'متوسط التفاعل',
                            data: [70, 85, 90, 75], // Illustrative engagement scores
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)', // Red
                                'rgba(54, 162, 235, 0.8)', // Blue
                                'rgba(255, 206, 86, 0.8)', // Yellow
                                'rgba(75, 192, 192, 0.8)'  // Green
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            title: {
                                display: false,
                                text: 'أداء المحتوى حسب النوع'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'مستوى التفاعل',
                                    font: {
                                        family: 'Inter',
                                    }
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            }
                        }
                    }
                });

                // Customer Journey Chart (Illustrative)
                const customerJourneyCtx = document.getElementById('customerJourneyChart').getContext('2d');
                myCustomerJourneyChart = new Chart(customerJourneyCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['الوعي (Awareness)', 'الاهتمام (Consideration)', 'التحويل (Conversion)', 'الولاء (Loyalty)'],
                        datasets: [{
                            data: [30, 25, 20, 25], // Illustrative percentages
                            backgroundColor: [
                                'rgba(153, 102, 255, 0.8)', // Purple
                                'rgba(255, 159, 64, 0.8)',  // Orange
                                'rgba(201, 203, 207, 0.8)', // Gray
                                'rgba(0, 200, 83, 0.8)'     // Green (for loyalty)
                            ],
                            borderColor: [
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(201, 203, 207, 1)',
                                'rgba(0, 200, 83, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                    }
                                }
                            },
                            title: {
                                display: false,
                                text: 'مراحل رحلة العميل'
                            }
                        }
                    }
                });

                completeTask(9); // Task 9: Generate Charts
                completeTask(10); // Task 10: Final Report Assembly

            } catch (error) {
                console.error("Error generating report:", error);
                reportContent.innerHTML = `<p class="text-red-600">حدث خطأ أثناء توليد التقرير: ${error.message}. يرجى المحاولة مرة أخرى.</p>`;
                reportOutput.classList.remove('hidden');
            } finally {
                // Hide loading overlay and stop message cycling
                loadingOverlay.classList.add('hidden');
                clearInterval(messageInterval);

                // Ensure the last task is marked as completed
                if (activeTaskIndex !== -1) {
                    const lastTaskItem = document.getElementById(`task-${activeTaskIndex}`);
                    if (lastTaskItem) {
                        lastTaskItem.classList.remove('active');
                        lastTaskItem.classList.add('completed');
                        lastTaskItem.querySelector('.task-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    }
                }

                // Re-enable button and hide loading spinner
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'توليد التقرير الشامل <i class="fas fa-magic mr-2"></i>';
                reportOutput.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to report
            }
        });

        // Copy report to clipboard
        copyReportBtn.addEventListener('click', () => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = reportContent.innerHTML;

            // Remove chart canvases as they can't be copied as images directly to text clipboard
            const canvases = tempDiv.querySelectorAll('canvas');
            canvases.forEach(canvas => canvas.remove());

            // Add a placeholder for charts
            const chartsSectionInReport = tempDiv.querySelector('.report-section h3') && tempDiv.querySelector('.report-section h3').textContent.includes('التحليلات والرسوم البيانية');
            if (chartsSectionInReport) {
                const chartsPlaceholder = document.createElement('p');
                chartsPlaceholder.innerHTML = '<br>--- الرسوم البيانية التحليلية (الرجاء الرجوع للتطبيق الأصلي للمعاينة المرئية) ---<br>';
                const firstReportSection = tempDiv.querySelector('.report-section');
                if (firstReportSection) {
                    firstReportSection.parentNode.insertBefore(chartsPlaceholder, firstReportSection.nextSibling);
                } else {
                    tempDiv.insertBefore(chartsPlaceholder, tempDiv.firstChild);
                }
            }

            const range = document.createRange();
            range.selectNode(tempDiv);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copySuccessMessage.classList.remove('hidden');
                    setTimeout(() => {
                        copySuccessMessage.classList.add('hidden');
                    }, 3000);
                } else {
                    prompt('نسخ التقرير (Ctrl+C / Cmd+C):', tempDiv.innerText);
                }
            } catch (err) {
                prompt('نسخ التقرير (Ctrl+C / Cmd+C):', tempDiv.innerText);
            } finally {
                window.getSelection().removeAllRanges();
            }
        });

        // Print to PDF Logic
        printPdfBtn.addEventListener('click', () => {
            const element = document.getElementById('reportOutput');
            const originalDisplay = element.style.display;

            // Temporarily remove social share buttons and developer info for cleaner PDF
            const socialShareSection = element.querySelector('.social-share-buttons');
            const developerInfoSection = element.querySelector('.report-section.bg-blue-50');
            const copySuccessMsg = element.querySelector('#copySuccessMessage');

            if (socialShareSection) socialShareSection.style.display = 'none';
            if (developerInfoSection) developerInfoSection.style.display = 'none';
            if (copySuccessMsg) copySuccessMsg.style.display = 'none';

            // Options for html2pdf
            const options = {
                margin: 10,
                filename: `تقرير-EhabGM-${document.getElementById('brandName').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(options).from(element).save().then(() => {
                // Restore original display after PDF generation
                if (socialShareSection) socialShareSection.style.display = originalDisplay;
                if (developerInfoSection) developerInfoSection.style.display = originalDisplay;
                if (copySuccessMsg) copySuccessMsg.style.display = originalDisplay;
            });
        });

        // Social Share Buttons Logic
        const currentAppUrl = window.location.href;

        document.getElementById('shareWhatsappBtn').addEventListener('click', () => {
            const shareText = `ألقِ نظرة على هذا التقرير التسويقي الشامل الذي تم إنشاؤه بواسطة وكيل EhabGM للتسويق الذكي! يمكنك إنشاء تقريرك الخاص مجانًا من هنا: ${currentAppUrl}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
        });

        document.getElementById('shareFacebookBtn').addEventListener('click', () => {
            const shareUrl = currentAppUrl;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
        });

        document.getElementById('shareTwitterBtn').addEventListener('click', () => {
            const shareText = `وكيل EhabGM للتسويق الذكي: أنشئ تقريرك التسويقي الشامل مجانًا الآن!`;
            const shareUrl = currentAppUrl;
            window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank');
        });

        document.getElementById('shareLinkedInBtn').addEventListener('click', () => {
            const shareTitle = `وكيل EhabGM للتسويق الذكي`;
            const shareSummary = `أداة ذكاء اصطناعي متكاملة لإنشاء خطط تسويقية احترافية وتحليلات عميقة لبراندك.`;
            const shareUrl = currentAppUrl;
            window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareTitle)}&summary=${encodeURIComponent(shareSummary)}`, '_blank');
        });

    </script>
</body>
</html>
